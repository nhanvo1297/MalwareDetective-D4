from django.shortcuts import render, redirect,HttpResponse
from .forms import UploadForm
from django.http import JsonResponse
import pyrebase
import os
from django.conf import settings
from django.core.files.storage import default_storage
from django.core.files.storage import FileSystemStorage
from django.contrib import messages
from pathlib import Path
from malware.settings import BASE_DIR
import pefile
import pprint
# Test Pefile
import logging



config = {
 
  "apiKey": "AIzaSyDrjABPNm-8rvKtpTNhFjraofGMN3ajrLw",
    "authDomain": "malwaredetective-c2327.firebaseapp.com",
    "projectId": "malwaredetective-c2327",
    "storageBucket": "malwaredetective-c2327.appspot.com",
    "messagingSenderId": "620692824989",
    "appId": "1:620692824989:web:cfd73f403cc63df046c574",
    "measurementId": "G-E774K8WWQR",
    "databaseURL": ""
}

firebase = pyrebase.initialize_app(config)
storage = firebase.storage()



# storage.child(path_on_cloud).put("/Users/nhan/Desktop/Counter-Strike Global Offensive.app")

# def home(request):
#     if request.method == 'POST':
#         file = request.FILES['document']
#         file_save = default_storage.save(file.name, file)
#         storage.child("files/" + file.name).put("media/files/" + file.name)
#         print("Uploaded file name: "+file.name)
#         print("Uploaded file size: "+str(file.size))
#         # delete = storage.delete(file.name)
#         messages.success(request, "File upload in Firebase Storage successful")
#         return redirect('index')
#     else:
#         return render(request, "fileUpload/index.html")


# def home_view(request):
#     form = UploadForm(request.POST or None, request.FILES or None)
#     if request.is_ajax():
#         if form.is_valid():
#             form.save()
#             return JsonResponse({'message':'hell yeah'})
#     context={ 'form':form,}
#     return render(request, "fileUpload/home.html",context)


def view_name(request):
    file_name = ""
    file_numberOfSections = ""
    file_DllChar =""
    file_ImageVersion = ""
    if request.method == 'POST' and 'myfile' in request.FILES:
        file = request.FILES['myfile']
        fs = FileSystemStorage()
        file_save = fs.save(file.name, file)
        uploaded_file_url = fs.url(file_save)
        print(uploaded_file_url)
        storage.child("files/" + file.name).put("media/" + file.name)
        print("Uploaded file name: "+file.name)
        print("Uploaded file size: "+str(file.size))
        
        #LOGGIN DEBUG
        logger = logging.getLogger('testlogger')
        

        #Test pefile
        file_name = file.name
        file_path = os.path.join(BASE_DIR, 'media/'+file.name)
        putty = pefile.PE(file_path)
        sections =  putty.FILE_HEADER.NumberOfSections
        dll = putty.OPTIONAL_HEADER.DllCharacteristics
        ver = putty.OPTIONAL_HEADER.MajorImageVersion
        
        # logger.info(file_path)
        # logger.info(file.name)
        # logger.info("\n Number of Sections:" + str(sections))
        # logger.info("\n Dynamic : "+str(dll))
        # logger.info("\n Image Version: "+str(ver))
        file_numberOfSections = "\n Number of Sections:" + str(sections)
        file_DllChar ="\n Dynamic : "+str(dll)
        file_ImageVersion = "\n Image Version: "+str(ver)
        messages.success(request, "File upload in Firebase Storage successful")
        
    return render(request, "fileUpload/home.html",{"FileName":file_name,"NumberOfSection":file_numberOfSections,"DllChar":file_DllChar,"ImageVersion":file_ImageVersion})
    